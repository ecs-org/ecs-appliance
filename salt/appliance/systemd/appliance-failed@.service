[Unit]
Description=Appliance Error
After=network.target

[Service]
Type=simple
ExecStart=/bin/bash -c '. /usr/local/share/appliance/env.include; userdata_to_env ecs,appliance; \
    . /usr/local/share/appliance/appliance.include; \
    (cat /app/etc/tags/last_running_ecs || echo "invalid") > /app/etc/tags/last_failed_ecs; \
    rm -f /app/etc/tags/last_running_ecs; \
    touch /run/appliance-failed; \
    extra=$((for i in prepare-env prepare-appliance prepare-ecs appliance; do \
        systemctl status -l -q --no-pager -n 20 ${i}.service; done) | text2json); \
    appliance_exit "Appliance Error" "Appliance (%I) failed to start, system in standby" critical "$extra"'
